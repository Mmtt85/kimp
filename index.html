<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <title>- / -</title>
  </head>
  <body>
    <div style="margin: 0 35%">
      <br />
      <span>다음 갱신까지... <span id="remain_times"></span>초</span>
    </div>
    <div style="margin: 0 35%">
      <h1>김치 프리미엄 계산기</h1>
      <table class="premium-table">
        <thead>
          <tr>
            <th></th>
            <th>BitBank</th>
            <th>UpBit</th>
            <th>Premium</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>XRP</td>
            <td><span id="bb_xrp"> - </span></td>
            <td><span id="upbit_xrp"> - </span></td>
            <td class="premium"><span id="premium_xrp"> - </span></td>
          </tr>
          <tr>
            <td>Solana</td>
            <td><span id="bb_solana"> - </span></td>
            <td><span id="upbit_solana"> - </span></td>
            <td class="premium"><span id="premium_solana"> - </span></td>
          </tr>
        </tbody>
      </table>
      <h2>
        환율 수동입력:
        <input id="rate_manual" value="" placeholder="ex) 9.2138" />
        <button id="capture" class="capture" onclick="startCapture()">
          캡쳐
        </button>
        <span>
          <span>아래 환율사이트가 정상적으로 로드된 상태에서</span>
          <br />
          <span>창 - 첫번째 창을 선택해주세요</span>
        </span>
      </h2>
      (미입력시 <span id="rate_auto"> - </span>로 계산)
      <span id="err_rate_manual" class="error"></span>
    </div>
    <div id="div_iframe" class="div-iframe" style="margin: 0 35%">
      <div>
        아래 사이트가 정상적으로 표시되지 않는다면:
        <button onclick="refresh_iframe()">리프레쉬</button>
      </div>
      <iframe
        id="iframe"
        src="https://kr.investing.com/currencies/jpy-krw"
        style="width: 400px; height: 400px"
        loading="lazy"
      ></iframe>
      <div>
        <input
          id="rate_site"
          value=""
          placeholder="환율사이트 직접입력"
          style="width: 350px"
        />
        <button onclick="getRateSite()">로드</button>
      </div>
    </div>
  </body>
</html>
<script>
  const getBbXrpPrice = async () => {
    const response = await fetch("https://public.bitbank.cc/xrp_jpy/ticker");
    const jsonData = await response.json();
    return _.get(jsonData, "data.last");
  };

  const getBbSolanaPrice = async () => {
    const response = await fetch("https://public.bitbank.cc/sol_jpy/ticker");
    const jsonData = await response.json();
    return _.get(jsonData, "data.last");
  };

  const getUpbitPrice = async () => {
    const response = await fetch(
      "https://api.upbit.com/v1/ticker?markets=KRW-XRP&markets=KRW-SOL"
    );
    const jsonData = await response.json();
    return [_.get(jsonData, "0.trade_price"), _.get(jsonData, "1.trade_price")];
  };

  const getRate = async () => {
    const response = await fetch("https://open.er-api.com/v6/latest/JPY");
    const jsonData = await response.json();
    const rateManual = document.querySelector("#rate_manual");
    const rateAuto = document.querySelector("#rate_auto");
    const KRW = _.get(jsonData, "rates.KRW");
    rateAuto.innerText = KRW;
    if (_.get(rateManual, "value")) {
      return parseFloat(rateManual.value);
    } else {
      return KRW;
    }
  };

  const getRateSite = async () => {
    const rateSite = document.querySelector("#rate_site");
    const iframe = document.querySelector("#iframe");
    if (_.get(rateSite, "value")) {
      iframe.src = rateSite.value;
    } else {
      iframe.src = "https://kr.investing.com/currencies/jpy-krw";
    }
  };

  const formatNumber = (num) => {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  };

  const get = async () => {
    const [bbXrp, bbSolana, upbitPrice, rate] = await Promise.all([
      getBbXrpPrice(),
      getBbSolanaPrice(),
      getUpbitPrice(),
      getRate(),
    ]);

    const [upbitXrp, upbitSolana] = upbitPrice;

    const updateTable = (bb, upbit, rate, bbId, upbitId, premiumId) => {
      const upbitYen = Math.floor(upbit / rate);
      const bbWon = Math.floor(bb * rate);
      const bbStr = `${formatNumber(bbWon)}₩<br>(${formatNumber(
        Math.floor(bb)
      )}¥)`;
      const upbitStr = `${formatNumber(upbit)}₩<br>(${formatNumber(
        upbitYen
      )}¥)`;

      const premium = parseFloat(((upbitYen - bb) / bb) * 100).toFixed(2);
      const premiumStr = `${premium} %`;

      document.querySelector(premiumId).style.color = `rgb(${
        premium * 100 > 255 ? 255 : premium * 100
      }, 0, 0)`;
      document.querySelector(bbId).innerHTML = bbStr;
      document.querySelector(upbitId).innerHTML = upbitStr;
      document.querySelector(premiumId).innerText = premiumStr;
    };

    updateTable(bbXrp, upbitXrp, rate, "#bb_xrp", "#upbit_xrp", "#premium_xrp");
    updateTable(
      bbSolana,
      upbitSolana,
      rate,
      "#bb_solana",
      "#upbit_solana",
      "#premium_solana"
    );

    document.querySelector("title").innerText = `${
      document.querySelector("#premium_xrp").innerText
    } / ${upbitXrp}`;
  };

  const startCapture = async () => {
    const button = document.querySelector("#capture");
    button.textContent = "데이터 추출중...";
    button.disabled = true;

    try {
      // 화면을 공유하는 스트림을 요청
      const stream = await navigator.mediaDevices.getDisplayMedia({
        video: true,
      });

      // 스트림의 비디오 트랙을 가져옴
      const video = document.createElement("video");
      video.srcObject = stream;

      video.play();

      // 비디오가 로드된 후 캔버스에 그리기
      video.onloadedmetadata = async () => {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        _.forEach(stream.getTracks(), (track) => track.stop());

        const imgData = canvas.toDataURL("image/png");

        // base64 이미지 데이터를 Tesseract에 보내 텍스트 추출
        const result = await Tesseract.recognize(imgData, "eng");
        const text = _.get(result, "data.text");
        const split_text = _.split(text, /\n| /g);
        _.forEach(split_text, (t) => {
          const result = /^\d+\.\d{4}$/g.test(t);
          if (result) {
            document.querySelector("#rate_manual").value = t;
            return false;
          }
        });

        button.textContent = "캡쳐";
        button.disabled = false;
      };
    } catch (error) {
      button.textContent = "캡쳐";
      button.disabled = false;
    }
  };

  const refresh_iframe = () => {
    const iframe = document.querySelector("#iframe");
    iframe.src = iframe.src; // 리프레쉬를 위한 코드임. 이 코드가 없으면 리프레쉬가 안됨.
  };

  let counter = 15;
  setInterval(() => {
    const remain_times = document.querySelector("#remain_times");
    remain_times.innerText = counter;
    if (counter == 0) {
      get();
      counter = 15;
    }
    counter--;
  }, 1000);
</script>
<style>
  div {
    padding: 5px 0px;
    text-align: center;
  }
  h2 {
    margin: 0px;
    padding: 10px 0px 5px 0px;
  }
  .error {
    color: rgb(255, 107, 107);
    font-size: 10pt;
  }
  .div-iframe {
    padding: 10px;
  }
  .capture:hover ~ span {
    display: unset;
  }
  .capture ~ span {
    font-size: 10pt;
    position: absolute;
    transform: translate(-80px, -40px);
    display: none;
    border: 1px solid gray;
    border-radius: 5px;
    padding: 2px;
    background-color: whitesmoke;
  }
  .w-full {
    width: 100%;
  }
  .premium-table {
    width: 100%;
    text-align: center;
    border-collapse: collapse;
    margin-bottom: 10px;
  }
  .premium-table th,
  .premium-table td {
    padding: 10px;
    border: 1px solid #ddd;
  }
  .premium-table thead tr {
    background-color: #f2f2f2;
  }
</style>
