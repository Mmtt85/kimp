<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <title></title>
  </head>
  <body>
    <div>
      <br />
      <span>다음 갱신까지... <span id="remain_times"></span>초</span>
    </div>
    <div>
      <h1>JPY-XRP 프리미엄 계산기</h1>
      <h2>BitBank: <span id="bb"> - </span></h2>
      <h2>UpBit: <span id="upbit"> - </span></h2>
      <h2 class="premium">Premium: <span id="premium"> - </span></h2>
      <h2>
        환율 수동입력:
        <input id="rate_manual" value="" placeholder="ex) 9.2138" />
      </h2>
      (미입력시 <span id="rate_auto"> - </span>로 계산)
      <span id="err_rate_manual" class="error"></span>
    </div>
    <div id="div_iframe" class="div-iframe">
      <div>
        아래 사이트가 정상적으로 표시되지 않는다면:
        <button onclick="refresh_iframe()">리프레쉬</button>
      </div>
      <iframe
        id="iframe"
        src="https://kr.investing.com/currencies/jpy-krw"
        style="width: 400px; height: 400px"
        loading="lazy"
      ></iframe>
      <div>
        <a target="_blank" href="https://kr.investing.com/currencies/jpy-krw">
          환율사이트 직접가기
        </a>
        <div>(https://kr.investing.com/currencies/jpy-krw)</div>
      </div>
    </div>
  </body>
</html>

<script>
  let counter = 15;
  const getBbXrpPrice = async () => {
    const response = await fetch("https://public.bitbank.cc/xrp_jpy/ticker");
    const data = await response.json();
    return data.data.last;
  };

  const getUpbitPrice = async () => {
    const options = { method: "GET", headers: { accept: "application/json" } };
    const response = await fetch(
      "https://api.upbit.com/v1/ticker?markets=KRW-XRP",
      options
    );
    const data = await response.json();
    return data[0].trade_price;
  };

  const getRate = async () => {
    const response = await fetch("https://open.er-api.com/v6/latest/JPY");
    const data = await response.json();
    const rateManual = document.querySelector("#rate_manual");
    if (rateManual.value) {
      return parseFloat(rateManual.value) * 10;
    } else {
      document.getElementById("rate_auto").innerText = data.rates.KRW;
      return data.rates.KRW * 10;
    }
  };

  const get = async () => {
    const [bb, upbit, rate] = await Promise.all([
      getBbXrpPrice(),
      getUpbitPrice(),
      getRate(),
    ]);

    const upbitYen = parseFloat((upbit * 10) / rate).toFixed(1);
    const bbWon = parseFloat((bb * rate) / 10).toFixed(1);
    const bbStr =
      parseFloat(bb).toFixed(1).toLocaleString() +
      " / " +
      parseFloat(bbWon).toFixed(1).toLocaleString();
    const upbitStr =
      upbitYen.toLocaleString() +
      " / " +
      parseFloat(upbit).toFixed(1).toLocaleString();

    const premiumStr =
      parseFloat(((upbitYen - bb) / bb) * 100).toFixed(2) + "%";

    document.getElementById("bb").innerText = bbStr;
    document.getElementById("upbit").innerText = upbitStr;
    document.getElementById("premium").innerText = premiumStr;
    document.querySelector("title").innerText = premiumStr;
  };

  const refresh_iframe = () => {
    const iframe = document.getElementById("iframe");
    iframe.src = iframe.src; // 리프레쉬를 위한 코드임. 이 코드가 없으면 리프레쉬가 안됨.
  };

  setInterval(() => {
    document.querySelector("#remain_times").innerText = counter;
    if (counter == 0) {
      get();
      counter = 15;
    }
    counter = counter - 1;
  }, 1000);
</script>
<style>
  .premium {
    color: rgb(255, 107, 107);
  }
  div {
    padding: 5px 0px;
    text-align: center;
  }
  h2 {
    margin: 0px;
    padding: 10px 0px 5px 0px;
  }
  .error {
    color: rgb(255, 107, 107);
    font-size: 10pt;
  }
  .div-iframe {
    padding: 10px;
  }
</style>
